# BulbCode

BulbCode是音箱网关使用的独立协议，用于控制灯的效果；不要和BulbBoot或BulbCast混淆。

| Protocol | 用途                                                     | magic    | 命令                                                         |
| -------- | -------------------------------------------------------- | -------- | ------------------------------------------------------------ |
| BulbBoot | 音箱网关用于控制基础固件（第一级）的指令                 | b01bb007 | blink, boot                                                  |
| BulbCode | 音箱网关用于控制功能固件（第二级）的指令                 | b01bc0de | 16bit encoded command                                        |
| BulbCast | 灯泡的广播，目前第一级有详细定义和实现，第二级需逐步完善 | b01bca57 | device info, aged time, temperature, illumination, lastwill etc. |



## 修改历史

2022-01-10, ma，调整`1000`和`1002`指令的内容顺序，将`Fade in Duration`调整到色彩之前；





## 格式

和BulbBoot一样，BulbCode实际上是使用ble advertisement packet中manufacturer data的最大26字节payload的数据发送。开发者只关心这26个字节即可，使用hex code格式加`\n`结尾发送给thin modem即可。

| magic (4 bytes) | seq (1 byte) | group id (4 bytes) | bit mask (2-4 bytes) | command (2 bytes) | payload (11-13 bytes)      |
| --------------- | ------------ | ------------------ | -------------------- | ----------------- | -------------------------- |
| b0 1b c0 de     | 00-0f        | a0 a1 a2 a3        | ff ff (ff ff)        | 0001              | 00000000000000000000000000 |

说明：

1. 包长永远是26字节；蓝牙数据包有整包校验，无需额外添加校验。
2. seq (sequence number)不用于事物或维护顺序，但需要一直变化，不然如果连续的两个命令的payload完全相同，第二个命令可能被接收者的底层过滤掉；
3. 与bulbboot命令不同，bulbcode的seq的最高4个bit为保留bit，未来可能用于变更bit mask长度；所以seq目前实际上在`00-0f`的取值范围内；也基于此，payload可能**仅有11字节**的可用空间；
4. group id和bulbboot命令一致，是组id；bulbcode实际上是纯组播（multicast）协议，仅有组播功能，无单播（unicast）功能；
5. bit mask掩码覆盖的设备都应该执行此包的命令；
   1. 例如：网关在boot阶段依次向两个不同设备发送了bulbboot指令，`boot_params`分别为`b0b1b2b30201`和`b0b1b2b30204`，则这两个设备均属于`b0b1b2b3`组，掩码分别为`0002`和`0010`，如果一个bulbcode指令的group id + bit mask为`b0b1b2b30012`，则这两个设备都应该执行该命令；
   2. 如果设计就是几个灯在一个场景里的动作永远一致，它们可以使用同一个掩码；例如摆放在角落外围的气氛灯可以有一样的指令，而且，如果command约定的行为具有随机性，即使使用同样掩码仍可获得随机不同效果；
6. command和payload用于表述命令；但日常里人直觉理解的一些灯光效果，例如pulse（脉冲闪烁），square wave（方波），没有很好的自然操作隐喻，只能被理解为一些极限情况，例如正弦波的波幅无穷大以至于饱和，斩波后成为方波。



## 模型

初步构想的混色和含时控制的模型是叠层逻辑，包括：

1. 基础颜色层，设置一个或者多个基础颜色，主要是考虑Hue；
2. 颜色变化层，对基础颜色做变化，该层负责变化方式，变化周期性，Hue和Saturation的变化幅度；
   1. 该层可以完全override基础颜色层的saturation设置（而不是混合），但原则上不该override基础颜色层的hue；
   2. 随机和同步设计见后面的讨论；
3. 亮度变化层，亮度变化层在颜色变化层之上；
   1. 亮度层可以是亮度开关（shutter），周期变化的透明度，
   2. 亮度变化层可以直接使用颜色变化层的周期，可以制造固定或随机的相位差；
4. 保留的中间层；目前不定义行为；
5. 音符层，类似打击乐的噪音或者音符；
   1. 一个『音符』包含颜色，亮度可以是一段短促的噪音振荡，或者ADSR包络（attack-decay-sustain-release envelope）；它叠加在其他层之上，且最终一定结束； 
   2. 原则上音符的数量不做限制，允许叠加；实际上不会同时叠加大量音符，灯光不是乐器具有音色而且人可以分离；例如鼓声和钢琴声同时出现，人可以分离；但红色和蓝色同时出现，人只会看到紫色；但设备可以以100ms的时间精度构成任意闪烁的Pattern，每次闪烁有不同的时间长度和强度变化，
   3. 例子：脉冲，爆闪，匹配噪音的脉冲叠加，例如雷声刀剑声，匹配音乐节奏，较为适合使用音符层实现。



以上设计尚处于摸索阶段，开发者尽最大可能保证设计一致性，但无法完全保证，如果有特殊效果已有设计无法完成而用户需要，必要的设计变更还是得有。



### 量感，随机，同步等

此段落描述一些开放的想法。

1. 量感在视觉上永远是重要的，4只亮度为1/4的灯一起工作，可以表现的效果远好于1只亮度为1的灯；
2. 灯的颜色只有在肉眼可以直接观察的时候才有颜色的解析力，而对于LED灯泡而言这是很低的亮度，在日常室内有自然光照明时，灯泡仅能看出是在发光的，谈不上明亮，也远不够照明；但是达到照明亮度的彩色灯，仅能用于短暂制造效果，无法有更好的表现力，也不适合表现环境背景，层次，质感，流动性，细微到观察力极限，仅注意观察才能看出的缓慢变化，而这些对于表现氛围是重要的；
3. 即使没有规则的几何摆放，随机堆在一起的一组灯，其中的一两个的变化仍然可以和其它灯构成前景事件和背景幕布的对比；
4. 堆在一起的一组灯，可以在色调，饱和度和亮度上都有细微的区别，可以有不同的变化周期，包括持续或连续的变化，或轻微的跃变；
5. 有量感就可以有随机性，制造层次和质感，避免单调；为避免编程的繁琐（通过连续大量命令逐一通知灯泡变化颜色亮度），可以让一组灯在一条设定颜色周期性变化的指令里，给出色调随机变化幅度，亮度随机变化的幅度，周期的随机变化幅度，以及具有随机性的启动等待时间，实现混杂效果；
6. 精确的同步单调的但富有力量感；使用相同的周期但错开启动时间实现相位（phase）差，可产生同步且错落有致的感受（层次）；
7. 在上述层的设计里，预期是每一层的逻辑能拿到底层的基础属性，例如颜色变化层可以知道基础颜色层有几个颜色；亮度变化层能知道颜色变化层当前在使用何种周期，上层可以选择是否和下层同步，或错开相位制造交错，比如亮度层可以让Hue在一段弧线AB上摆动时，A端亮B端暗，或者相反；但层的设计里下层不了解上层的行为；



### 色彩空间说明

灯泡的色彩空间收到两个方面的限制，一个是球泡的反射光比例很高，目测在50%以上，比Kindle的电子纸反射率更高，另一个作为发光器件，通常比环境明量，这两点导致在色彩空间中只有HSV空间中的很少一部分是有分辨力的，在FastLED HSV空间（见命令`0x1002`）里，这个区域是：

```
H: 00-ff
S: e0-ff
V: 00-40
```

这个区域和任何工具软件的色盘都不一样，所以创作者务必用实体灯泡在较暗或较接近实际使用场景的照明下去调光。其它区域都是灰白光且因为器件不一致，偏色不同，人眼对白平衡很敏感，三色不平衡一眼就可以看出来。



## 码表

以下编码中如果整数类型超过1字节长度，均使用Most Significant Byte在前面的字节序。例如`(uint16_t)255`是`00 ff`，不是`ff 00`。



编码空间为`uint16_t`，共`65536`，实际上因分层合成模式的使用，远远用不到这样的编码空间。预计的编码分配方式如下：

| 范围      | 分配                           |
| --------- | ------------------------------ |
| 0000~0fff | 基础设置，如果有的话           |
| 1000~1fff | 基础颜色层                     |
| 2000~2fff | 颜色变化层                     |
| 3000~3fff | 亮度变化层                     |
| 8000~8fff | 音符层                         |
| ff00~ffff | 开发者使用，不要在生产环境使用 |



### 1. 基础颜色层

#### 0x1000 primary color fade in, RGB (0-255 for each color)

本命令使用RGB设置基础色中的主色，支持过渡。

使用RGB色彩空间，但RGB色彩空间主要是给测使用，使用网页上或工具软件里得到的RGB色彩从本命令设置色彩，只有高饱和度低亮度的部分色彩是可用的，RGB色彩空间中95%以上的色彩都无法使用。

Fade in Duration是过渡时间，是过渡到所设置色彩的过渡时间，本命令使用RGB空间的线性过渡；不保持颜色饱和度，也不经过white-out（经白色的过渡）和black-out（经黑色的过渡），如果有这方面的需求请联系开发者。

| code (2 bytes) | option bits (1 bytes) | Fade in Duration (2 bytes, MSB) | RGB (3 bytes) | Reserved (7 bytes) |
| -------------- | --------------------- | ------------------------------- | ------------- | ------------------ |
| `1000`         | `00`                  | `0000`                          | `rrggbb`      | `000000000000`     |

| option bits | bit mask | 含义                                                         |
| ----------- | -------- | ------------------------------------------------------------ |
| `00000001b` | (1 << 0) | 如果设置，duration以秒为单位，如果未设置，duration以100毫秒为单位，如果duration为0则无过渡。 |
| `01111110b` | -        | reserved，请设置为0。                                        |

补充：

1. 使用本命令并设置RGB均为0可以完全关闭发光。



#### 0x1002 primary color fade in, FastLED HSV (H: 0-255, S: 0-255, V: 0-255)

本命令使用FastLED HSV设置基础色中的主色，支持过渡。

`FastLED`是一个开源项目，提供搞了HSV和RGB转换的高效算法。通常HSV的取值范围是色调（Hue）0-360度浮点数，饱和度（Saturation）0-100百分比浮点数，亮度（Value）0-100百分比浮点数；而FastLED使用的HSV范围均为0-255整数，数据类型`uint8_t`。

`FastLED`里提供了两种不同的色谱，一个称为spectrum，是正常的日光色谱，另一个是针对彩色LED增强的rainbow色谱，当前使用前者，未提供设置选项。

使用本命令时的色彩过渡采用HSV空间的渐变过渡，视觉上最显著的变化是Hue的连续变化，例如从red到green会经过yellow，而不是从RGB空间里的“灰块”里穿过去。

HSV色彩符合创作者直觉且HSV空间的饱和色过渡色彩丰富，推荐开发者在设置主色时仅使用该方法。

| code (2 bytes) | option bits (1 bytes) | Fade in Duration (2 bytes, MSB) | HSV (3 bytes) | Reserved (7 bytes) |
| -------------- | --------------------- | ------------------------------- | ------------- | ------------------ |
| `1002`         | `00`                  | `0000`                          | `hhssvv`      | `00000000000000`   |

| option bits | bit mask | 含义                                                         |
| ----------- | -------- | ------------------------------------------------------------ |
| `00000001b` | (1 << 0) | 如果设置，duration以秒为单位，如果未设置，duration以100毫秒为单位，如果duration为0则无过渡。 |
| `00000010b` | (1 << 1) | 0: 自动选择色调的短弧线做颜色过渡；1: 手动指定色调过渡弧线。 |
| `00000100b` | (1 << 2) | 在手动指定色调过渡弧线的前提下，0使用顺时针，1使用逆时针；顺时针指red-yellow-green-teal-blue-purple这个顺序。 |
| `11111000b` | -        | reserved，请设置为0。                                        |

使用本命令并设置HSV中的V为0可以完全关闭发光，和RGB命令不同这种关闭保留了色调和饱和度设置，在下一次设置时从保留的色调和饱和度开始fade-in渐变，而不是从“灰白”的低亮度开始。



##### Example

```
# 
# magic    seq groupId  bits  code opt duration hsv    padding
  b01bc0de 00  a5a5a5a5 0001  1002 00  0020     88ff33 00000000000000
```



### 2. 颜色变化层

颜色变化层包含三个正交的责任：

1. 定义时域模式；
2. 定义颜色在时域内的变化方式，包括色调和饱和度，但不包括亮度；
3. 定义随机性；



时域模式包括严格周期，可变周期，随机可变周期，伪周期等等。





----













